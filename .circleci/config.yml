version: 2.1 # Use version 2.1 to enable orb usage.
defaults: &dockerbase
  docker:
    - image: circleci/node:13.8.0
  working_directory: /tmp

commands: 
  sayhello:
    description: "Simple command to say hello"
    parameters: 
      hello_to: 
        type: string
        default: "Hello World"
      file_name:
        type: string
        default: "ss_workspace/test.txt"
    steps:
      - run: echo << parameters.hello_to >> >> << parameters.file_name >>

jobs:
  print_hello_user:
    <<: *dockerbase
    steps:
      - run: mkdir -p ss_workspace 
      - run: mkdir -p cachefolder1
      - sayhello: 
          hello_to: "$CIRCLE_WORKFLOW_ID ! calling to sayhello test 1, saved by workspace"
          file_name: "/tmp/ss_workspace/ssfile1.txt"
      - sayhello: 
          hello_to: "$CIRCLE_WORKFLOW_ID, call success to say hello, saved in cache"
          file_name: "/tmp/cachefolder/test.txt"
      - run: 
          command: echo "error has occured in creating test file at cachefolder" >>/tmp/ss_workspace/error_log.txt
          when: on_fail
      - save_cache:
          key: v1-my-project-{{ checksum "cachefolder/test.txt" }}
          paths:
            - /tmp/cachefolder/test.txt      
      - run: 
          command: echo "error has occured in saving cache of cachefolder" >>/tmp/ss_workspace/error_log.txt
          when: on_fail      
      - save_cache:
          key: v2-my-{{ checksum "ss_workspace/error_log.txt" }}
          paths:
            - /tmp/ss_workspace/error_log.txt

  get_hello_user:
    <<: *dockerbase
    steps:
      - restore_cache:
          keys: 
            - v1-my-project
            - v2-my
      - run: pwd
      - run: echo "Good Morning, saved workspace successful !!" >>/tmp/ss_workspace/ssfile1.txt
      - run: cat /tmp/ss_workspace/ssfile1.txt      
      - run: cat /tmp/ss_workspace/error_log.txt
      

workflows:
  say-hello-workflow:
    jobs:
      - print_hello_user
      - get_hello_user:
          requires:
            - print_hello_user